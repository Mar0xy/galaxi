name: Build App and Create Pre-Release

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  CHANGELOG_COMMIT_LIMIT: 20  # Maximum number of commits to include in changelog when no tags exist

jobs:
  release-build:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libsqlite3-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
      
      - name: Configure Flutter
        run: |
          flutter config --no-analytics
          flutter config --no-cli-animations
          flutter --disable-analytics
          dart --disable-analytics
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install backend dependencies
        run: |
          cd typescript
          bun install
      
      - name: Build backend executable
        run: |
          cd typescript
          bun run build
          chmod +x galaxi-backend
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Build Linux app
        run: flutter build linux --release
      
      - name: Extract version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version detected: $VERSION"

      - name: Package Linux app
        run: |
          cd build/linux/x64/release/bundle
          # Include standalone backend executable in renamed folder
          mkdir -p backend
          cp ../../../../../typescript/galaxi-backend backend/
          cp ../../../../../start-galaxi.sh .
          tar -czvf "../../../../../galaxi-linux-${{ steps.version.outputs.version }}-x64.tar.gz" *
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, generating full history"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges | head -${{ env.CHANGELOG_COMMIT_LIMIT }})
          else
            echo "Generating changelog since $LATEST_TAG"
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Create changelog file
          cat > changelog.md << EOF
          ## What's New in v${{ steps.version.outputs.version }}
          
          ### Changes:
          $COMMITS
          
          ### Installation
          
          1. Download the tar.gz file
          2. Extract it
          3. Go into folder
          3. Run it: \`./start-galaxi.sh\`
          
          ### Requirements
          
          - Linux (tested on Ubuntu 22.04)
          - GTK3
          - Wine (optional, for running Windows games)
          
          ---
          
          *This is a pre-release build. Please report any issues on GitHub.*
          EOF
          
          echo "Changelog generated"
          cat changelog.md
      
      - name: Create Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}-pre
          name: Galaxi v${{ steps.version.outputs.version }} (Pre-Release)
          body_path: changelog.md
          prerelease: true
          files: |
            galaxi-${{ steps.version.outputs.version }}-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
