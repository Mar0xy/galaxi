name: Build AppImage and Create Pre-Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

env:
  CHANGELOG_COMMIT_LIMIT: 20  # Maximum number of commits to include in changelog when no tags exist

jobs:
  build-appimage:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libsqlite3-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
      
      - name: Configure Flutter
        run: |
          flutter config --no-analytics
          flutter config --no-cli-animations
          flutter --disable-analytics
          dart --disable-analytics
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install backend dependencies
        run: |
          cd typescript
          bun install
      
      - name: Build backend executable
        run: |
          cd typescript
          bun run build
          chmod +x galaxi-backend
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Build Linux app
        run: flutter build linux --release

      - name: Install SHC
        run: |
          sudo add-apt-repository ppa:neurobin/ppa
          sudo apt-get update
          sudo apt-get install shc

      - name: Convert Shell to Binary
        run: |
          cp appimage/AppRun.sh AppRun.sh
          shc -f AppRun.sh -o galaxi-run
          rm AppRun.sh

      - name: Download and setup appimage-builder
        run: |
          # Note: Downloading from continuous release. The URL is specified in the issue.
          # For production use, consider pinning to a specific release version.
          wget -q https://github.com/Lord-Kamina/appimage-builder/releases/download/continuous/appimage-builder_x86_64-AppImage.tar
          tar -xvf appimage-builder_x86_64-AppImage.tar --transform='s/.*\///'
          chmod +x appimage-builder-*-x86_64.AppImage
          # Move to a location in PATH
          sudo mv appimage-builder-*-x86_64.AppImage /usr/local/bin/appimage-builder
      
      - name: Extract version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version detected: $VERSION"
      
      - name: Build AppImage
        run: |
          cd appimage
          appimage-builder --recipe AppImageBuilder.yml --skip-test
      
      - name: Rename AppImage with version
        run: |
          # Find the generated AppImage in appimage directory
          APPIMAGE=$(find appimage -maxdepth 1 -name "*.AppImage" -type f)
          if [ -z "$APPIMAGE" ]; then
            echo "Error: No AppImage found"
            exit 1
          fi
          # Move and rename with version
          mv "$APPIMAGE" "galaxi-${{ steps.version.outputs.version }}-x86_64.AppImage"
          echo "AppImage created: galaxi-${{ steps.version.outputs.version }}-x86_64.AppImage"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, generating full history"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges | head -${{ env.CHANGELOG_COMMIT_LIMIT }})
          else
            echo "Generating changelog since $LATEST_TAG"
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Create changelog file
          cat > changelog.md << EOF
          ## What's New in v${{ steps.version.outputs.version }}
          
          ### Changes:
          $COMMITS
          
          ### Installation
          
          1. Download the AppImage file
          2. Make it executable: \`chmod +x galaxi-*.AppImage\`
          3. Run it: \`./galaxi-*.AppImage\`
          
          ### Requirements
          
          - Linux (tested on Ubuntu 22.04)
          - GTK3
          - Wine (optional, for running Windows games)
          
          ---
          
          *This is a pre-release build. Please report any issues on GitHub.*
          EOF
          
          echo "Changelog generated"
          cat changelog.md
      
      - name: Create Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}-pre
          name: Galaxi v${{ steps.version.outputs.version }} (Pre-Release)
          body_path: changelog.md
          prerelease: true
          files: |
            galaxi-${{ steps.version.outputs.version }}-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: galaxi-appimage
          path: galaxi-${{ steps.version.outputs.version }}-x86_64.AppImage
          retention-days: 30
